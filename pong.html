<html>
<head>
<title>Pong</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="/js/DataStream.js"></script>
<script src="/js/three.min.js"></script>
<script type="text/javascript">

var ents = new Object()
var actions = 0
var interval = 1000/30;
var camera, scene, renderer;
var pGeom, p1mat, p2mat;
var ballGeom, ballMat;

function init3d() {
	camera = new THREE.PerspectiveCamera( 75, 400/300, 1, 10000 );
	camera.position.z = 100;

	scene = new THREE.Scene();

	pGeom = new THREE.CubeGeometry( 10, 40, 10 );
	p1mat = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true } );
	p2mat = new THREE.MeshBasicMaterial( { color: 0x0000ff, wireframe: true } );

	ballGeom = new THREE.CubeGeometry(5,5,5);
	ballMat = new THREE.MeshBasicMaterial( { color: 0x00ff00, wireframe: true } );

	renderer = new THREE.CanvasRenderer();
	renderer.setSize( 400, 300)

	document.body.appendChild( renderer.domElement);
}

$(document).ready(function() {
	if ("WebSocket" in window) {
		init3d()
		// Let us open a web socket
		ws = new WebSocket("ws://localhost/ws/pong");
		ws.binaryType = "arraybuffer";
		ws.onopen = function() {
			console.log("sending commands")
			clientFrame()
		}
		ws.onmessage = function(evt) {
			var state = new DataStream(evt.data)

			var srvTime = state.readUint32()
			var lastAck = state.readUint32()
			var lastRx = state.readUint32()

			var nEnts = state.readUint32()
			var ids = state.readUint32Array(nEnts)

			var newEnts = new Object()
			for (var i = 0; i<nEnts; i++) {
				if (!ents[ids[i]]) {
					newEnts[ids[i]]=new Object()
					newEnts[ids[i]].mesh =
						new THREE.Mesh(pGeom,ballMat)
					scene.add(newEnts[ids[i]].mesh)
				}else{
					newEnts[ids[i]] = ents[ids[i]]
					delete ents[ids[i]]
				}
			}

			var nBytes = Math.ceil(nEnts/8)

			var bitMask = state.readUint8Array(nBytes)
			for (var i = 0; i<nEnts; i++) {
				var byIx = Math.floor(i / 8)
				var bitIx = (i % 8)
				if ((bitMask[byIx] & (1<<bitIx))>0) {
					newEnts[ids[i]].pos = state.readFloat64Array(3)
				}
				
			}

			var bitMask = state.readUint8Array(nBytes)
			for (var i = 0; i<nEnts; i++) {
				var byIx = Math.floor(i / 8)
				var bitIx = (i % 8)
				if ((bitMask[byIx] & (1<<bitIx))>0) {
					newEnts[ids[i]].vel =
						state.readFloat64Array(3)
				}
				
			}

			for (var id in ents) {
				if(ents[id].mesh) {
					scene.remove(ents[id].mesh)
				}
			}

			ents = newEnts
		}
		ws.onclose = function() { 
			console.log("Connection is closed..."); 
		};

	}else{
		alert("no websockets on your browser")
	}
	document.onkeydown = function(event) {
		var key_press = String.fromCharCode(event.keyCode);
		var key_code = event.keyCode;
		$('#kp').html(key_press)
		$('#kc').html(key_code)
		if (key_code == 87) {
			actions |= 1<<0
		}
		if (key_code == 83) {
			actions |= 1<<1
		}
		$('#status').html( "DOWN Event Fired For : "+key_press)
	}
	document.onkeyup = function(event){
		var key_press = String.fromCharCode(event.keyCode);
		var key_code = event.keyCode;
		if (key_code == 87) {
			actions &= ~(1<<0)
		}
		if (key_code == 83) {
			actions &= ~(1<<1)
		}
		$('#status').html( "UP Event Fired For : "+key_press)
	}
})

function clientFrame() {
	setTimeout(function() {
		window.requestAnimationFrame(clientFrame);

		for(var id in ents) {
		ents[id].mesh.position.set(
			ents[id].pos[0],
			ents[id].pos[1],
			ents[id].pos[2])
		}
		renderer.render(scene, camera)
		sendCmd();
	}, interval);
}
function sendCmd() {
	var d = new Date()
	var cmd = new DataStream()
	cmd.writeUint32(1)//lastrx

	cmd.writeUint32(0)//id
	cmd.writeUint32(0)//d.getTime())//time
	cmd.writeUint32(0)//status
	cmd.writeFloat64(0)//target
	cmd.writeFloat64(0)//target
	cmd.writeFloat64(0)//target
	cmd.writeUint32(actions)//actions

	ws.send(cmd.buffer);
}
</script>
</head>
<body>
<h2>Javascript Capture Keyboard Input Example</h2>
<h3>onkeydown - onkeyup</h3>
Key Pressed : <span id="kp"></span>
<br />
Key Code : <span id="kc"></span>
<p id="status">Keyboard Event Status</p>
<div id="world"></div>
</body>
</html>
